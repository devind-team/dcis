# Проект сборов

# Для разработчиков

Приложение состоит из двух сервисов:

* Django сервер, реализующий GraphQL API (папка `server`)
* SSR Nuxt клиент (папка `client`)

Для работы приложения должны быть запущены **оба сервиса**.

## IDE
Рекомендованной средой разработки является PyCharm.

Обязательные плагины:
* Vue.js
* Pug
* GraphQL

Рекомендованные плагины:
* GitToolBox
* Conventional Commit

## Настройка Django сервера (папка `server`)
Для работы сервиса обязательно необходимы следующие зависимости:

| Зависимость                                                  | Версия |
|--------------------------------------------------------------|--------|
| [Python](https://www.python.org/downloads/)                  | 3.10   |
| [Poetry](https://python-poetry.org/docs/#installation)       | latest |
| [PostgreSQL](https://www.postgresql.org/download/)           | latest |
| [Redis](https://redis.io/docs/getting-started/installation/) | latest |

Для Windows Redis официально не поддерживается,
поэтому необходимо или установить WSL, как это описано на 
[сайте Redis](https://redis.io/docs/getting-started/installation/install-redis-on-windows/),
или воспользоваться [неофициальном портом](https://github.com/tporadowski/redis/releases).

Для некоторых **редких** сценариев работы с файлами требуется установленный
[OpenOffice](https://www.openoffice.org/download/index.html).
Для запуска таких сценариев из Windows
рекомендуется запускать Django сервер в WSL с установленным OpenOffice.

Здесь и далее все команды
должны выполняться из папки `server`, для перехода необходимо выполнить команду:
```shell
cd server
```
Префикс `poetry run` для всех команд может быть опущен
при активированном виртуальном окружении в терминале.
Активация окружения описана в секции "Дополнительные настройки PyCharm".

После установки зависимостей необходимо:

1. Создать базу данных PostgreSQL.

Имя базы данных по умолчанию - `devind`.

2. Создать `.env` файл в папке `server`.  

Создать файл можно путем копирования файла `.env.example` с новым названием `.env`.

При необходимости в файле нужно поменять данные для подключения к базе данных:
* Имя базы данных (ключ `DB_APP_NAME`)
* Пользователь (ключ `DB_APP_USER`)
* Пароль (ключ `DB_APP_PASSWORD`)

На **Windows** также необходимо удалить из созданного файла все комментарии, начинающиеся с символа `#`.

3. Установить зависимости Python

Для установки зависимостей Python необходимо выполнить команду:  
```shell
poetry install
```

4. Убедиться в том, что Redis сервер запущен

На Unix это можно сделать следующей командой:
```shell
sudo service redis-server restart
```

На Windows необходимо зайти в диспетчер задач и запустить службу `Redis`,
если она остановлена.

5. Выполнить скрипт, заполняющий базу данных начальными данными

Сделать это можно следующей командой:
```shell
# Unix
poetry run python3 manage.py fs
# Windows
poetry run python manage.py fs
```

Далее сервис может быть запущен следующей командой:
```shell
# Unix
poetry run python3 manage.py runserver
# Windows
poetry run python manage.py runserver
```

### Дополнительные настройки PyCharm
Для удобной работы с сервисом из PyCharm необходимо:

1. Активировать Python окружение в терминале

Для активации окружения необходимо перейти `File`, `Settings`, `Project: dcis`, `Python interpreter`.
Далее необходимо нажать на кнопку с шестеренкой, далее кнопка `Add`.
В открывшемся диалоговом меню необходимо выбрать пункт `Poetry Environment`, далее `Existing Environment`.
Pycharm должен автоматически определить путь к окружению, созданному с помощью команды `poetry install`.
Далее необходимо нажать на кнопку `Ok` в обоих меню.

2. Настроить Django

Для настройки Django необходимо перейти `File`, `Settings`, `Languages & Frameworks`, `Django`.
Далее необходимо активировать пункт `Enanle Django Support`,
выбрать папку `server` в качестве `Django project root`,
а файл `server/deving/settings.py` в качестве `Settings`, затем нажать кнопку `Ок`.

3. Настроить конфигурацию

Настройка конфигурации осуществляется в правом верхнем углу возле кнопки `Run`.
Необходимо выбрать или `Add Configuration...`, если ни одна конфигурация не создана,
или `Edit Configurations...`, если ранее были созданы конфигурации.
Далее необходимо нажать на кнопку `+` в левом верхнем углу,
выбрать `Django Server` из списка, ввести имя конфигурации (например, "server")
и нажать кнопку `Ok`.

После описанных выше действий появляется возможность:
1. Запускать команды без префикса `poetry run`.
2. Пользоваться `Python Console` c настроенным и запущенным Django.
3. Запускать сервис путем нажатия кнопки `Run`.

## Настройка Nuxt клиента (папка client)
Для работы сервиса необходимы следующие зависимости:

| Зависимость                                               | Версия     |
|-----------------------------------------------------------|------------|
| [Node.js](https://nodejs.org/en/)                         | latest LTS |
| [Yarn](https://classic.yarnpkg.com/lang/en/docs/install/) | latest     |

После установки зависимостей необходимо:

1. Создать `.env` файл в папке `client`.

Создать файл можно путем копирования файла `.env.example` с новым названием `.env`.

2. Установить зависимости Node.js.

Для установки зависимостей Node.js необходимо перейти в папку `client` и выполнить команду:  
```shell
yarn
```

3. Создать символическую ссылку между клиентом и сервером.

Для возможности выгрузки файлов необходимо создать символическую ссылку
на папку `server/storage` в папке `client/static`.

Для этого в Unix необходимо в корне проекта выполнить команду:
```shell
sudo python3 init.py
```

В Windows необходимо открыть терминал от имени администратора
и в корне проекта выполнить команду:
```shell
python init.py
```

Далее сервис может быть запущен из папки `client` следующей командой:
```shell
yarn run dev
```

### Дополнительные настройки PyCharm
Для удобной работы с сервисом из PyCharm необходимо настроить конфигурацию.

Настройка конфигурации осуществляется в правом верхнем углу возле кнопки `Run`.
Необходимо выбрать или `Add Configuration...`, если ни одна конфигурация не создана,
или `Edit Configurations...`, если ранее были созданы конфигурации.
Далее необходимо нажать на кнопку `+` в левом верхнем углу и
выбрать `npm` из списка.
Затем необходимо ввести имя конфигурации (например, "client"),
выбрать в качестве файла `package.json` файла `client/package.json`,
а в качестве `Scripts` команду `dev`. В конце необходимо нажать на кнопку `Ок`.

После настройки конфигурации появляется возможность запускать сервис путем нажатия кнопки `Run`.

#  Права доступа и режимы работы

Настоящий документ содержит информацию о правах доступа и режимах работы документов.

## Выборка объектов

Пользователь видит в соответствующей таблице только те проекты, периоды и документы, которые он может просматривать.

## Режим создания периодов

При создании периода указывается тип сбора:
- **множественный** - для каждого дивизиона создается свой уникальный документ со своим сквозным версионированием. 
- **единичный** - для всех дивизионов создается единый документ, фильтрация осуществляется на уровне динамических строк.

## Механизм привилегий

Привилегии делятся на глобальные и локальные.
Глобальные привилегии устанавливаются для групп пользователей
по пути "Панели управления" -> "Администрирование" -> "Привилегии" и применяются для всего приложения.
Локальные привилегии устанавливаются для конкретных пользователей или групп пользователей
в настройках каждого периода (панель Пользователи) и действуют только на этот период.

## Привилегии и права для работы с **Проектами** сборов

Просматривать проект могут пользователи, обладающие хотя бы одним из следующих свойств:
- `dcis.view_project` - пользователь обладает глобальной привилегией, позволяющей просматривать все проекты;
- `Project.user_id == info.context.user.id` - пользователь создал проект;
- `Project.visibility && info.context.user in Project.period.user` - проект является видимым и
  пользователь создал один из периодов проекта;
- `Project.visibility && info.context.user in Project.period.periodgroup.users` - проект является видимым и
  пользователь состоит в группе одного из периодов проекта;
- `Project.visibility && Project in get_user_curator_projects(info.context.user)` - проект является видимым и
  пользователь является куратором для одного из периодов проекта;
- `Project.visibility && Project in get_user_privileges_projects(info.context.user)` - проект является видимым и
  пользователь имеет привилегию для одного из периодов проекта;
- `Project.visibility && Project in get_user_divisions_projects(info.context.user)` - проект является видимым и
  пользователь состоит в дивизионе, который участвует в проекте.

Добавлять проект могут пользователи, обладающие хотя бы одним из следующих свойств:
- `dcis.add_project` - пользователь обладает глобальной привилегией, позволяющей добавлять проекты.

Изменять проект могут пользователи, способные просматривать этот проект и обладающие хотя бы одним из следующих свойств:
- `dcis.change_project` - пользователь обладает глобальной привилегией, позволяющей изменить любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project` - пользователь 
  создал проект и обладает возможностью создания проектов.

Удалять проект могут пользователи, способные просматривать этот проект и обладающие хотя бы одним из следующих свойств:
- `dcis.delete_project` - пользователь обладает глобальной привилегией, позволяющей удалить любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project && Project.period_set.count() == 0` - пользователь
  создал проект и обладает возможностью создания проектов, а также проект не должен иметь периодов.

**Привилегии и права, связанные с проектом, не распространяется на периоды и документы этого проекта.**

## Привилегии и права для работы с **Периодами** проекта сборов

Просматривать период могут пользователи, способные просматривать проект периода и
обладающие хотя бы одним из следующих свойств:
- `dcis.view_period` - пользователь обладает глобальной привилегией,
  позволяющей просматривать все периоды в рамках проекта;
- `Period.project.user.id == info.context.user.id` - пользователь создал проект с периодом;
- `Period.user.id == info.context.user.id` - пользователь создал период;
- `info.context.user in Period.groups` - пользователь состоит в группе периода;
- `Period in get_user_curator_periods(info.context.user)` - пользователь является куратором для периода;
- `Period in get_user_privileges_periods(info.context.user)` - пользователь имеет привилегию для периода;
- `Period in get_user_divisions_periods(info.context.user)` - пользователь состоит в дивизионе,
  который участвует в периоде.

Добавлять период могут пользователи, способные просматривать проект периода и
обладающие хотя бы одним из следующих свойств:
- `dcis.add_period` - пользователь обладает глобальной привилегией, позволяющей добавлять период в любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project` - пользователь
  создал проект, в который пытается добавить период, и обладает возможностью создания проектов.

Изменять период могут пользователи, способные просматривать этот период и обладающие хотя бы одним из следующих свойств:
- `dcis.change_period` - пользователь обладает глобальной привилегией, позволяющей изменить любой видимый период;
- `Period.project.user_id == info.context.user.id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается изменить дивизионы, и обладает возможностью создания проектов;
- `Period.user_id == info.context.user.id && dcis.add_period` - пользователь
  создал период, в котором пытается изменить дивизионы, и обладает возможностью создания периодов;
- `change_period` - пользователь обладает локальной привилегией, позволяющей изменять конкретный период.

Изменять дивизионы периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_divisions` - пользователь обладает локальной привилегией,
  позволяющей изменять дивизионы конкретного периода.

Изменять группы периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_groups` - пользователь обладает локальной привилегией,
  позволяющей изменять группы конкретного периода.

Изменять пользователей периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_users` - пользователь обладает локальной привилегией,
  позволяющей изменять пользователей конкретного периода.

Изменять аттрибуты периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_attributes` - пользователь обладает локальной привилегией,
  позволяющей изменять атрибуты конкретного периода. 

Изменять настройки периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_settings` - пользователь обладает локальной привилегией,
  позволяющая изменять настройки конкретного периода.

Удалять период могут пользователи, способные просматривать этот период и обладающие хотя бы одним из следующих свойств:
- `dcis.delete_period` - пользователь обладает глобальной привилегией, позволяющей удалить любой видимый период;
- `Period.project.user_id == info.context.user.id && dcis.add_project && Period.document_set.count() == 0` - 
  пользователь создал проект, в котором пытается удалить период, и обладает возможностью создания проектов,
  при этом в периоде не должно быть созданных документов;
- `Period.user_id == info.context.user.id && dcis.add_period && Period.document_set.count() == 0` - 
  пользователь создал период, который пытается удалить, и обладает возможностью создания периодов,
  при этом в периоде не должно быть созданных документов.

**Привилегии и права, связанные с периодом, не распространяется на таблицу и документы этого периода.**

## Привилегии и права для работы с **Документами** периода сборов

Просматривать документ могут пользователи, способные просматривать период документа и
обладающие хотя бы одним из следующих свойств:
- `dcis.view_document` - пользователь обладает глобальной привилегией,
  позволяющей просматривать все документы в рамках периода;
- `Document.period.project.user_id == info.context.user.id` - пользователь создал проект документа;
- `Document.period.user_id == info.context.user.id` - пользователь создал период документа;
- `Document.user_id == info.context.user.id` - пользователь создал документ;
- `is_document_curator(info.context.user, Document)` - пользователь является куратором для документа;
- `Document.object_id in get_user_divisions(info.context.user, Document.period.project)` - период создан с
  множественным типом сбора, и пользователь добавлен в закрепленный за документом дивизион;
- `Document.rowdimension__object_id in get_user_divisions(info.context.user, Document.period.project)` - период создан с
  единичным типом сбора, и пользователь добавлен в закрепленный за одной из строк документа дивизион;
- `view_document` - пользователь обладает локальной привилегией,
  позволяющей просматривать все документы конкретного периода;

Добавлять документ могут пользователи, способные просматривать период документа и
обладающие хотя бы одним из следующих свойств:
- `dcis.add_document` - пользователь обладает глобальной привилегией, позволяющей добавлять документ
  в любой видимый период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается добавить документ, и обладает возможность создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период, в котором пытается добавить документ, и обладает возможностью создания периодов;
- `add_document` - пользователь обладает локальной привилегией, позволяющей добавлять документы в конкретный период;
- в множественном типе сбора:
  - дивизион пользователя добавлен в период.

Изменять комментарий документа могут пользователи, способные просматривать этот документ и
обладающие хотя бы одним из следующих свойств:
- `dcis.change_document` - пользователь обладает глобальной привилегией, позволяющей изменять любой видимый документ;
- `Document.period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается изменить документ, и обладает возможностью создания проектов;
- `Document.period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период, в котором пытается изменить документ, и обладает возможностью создания периодов;
- `Document.user_id == info.context.user_id` - пользователь создал документ;
- `change_document` - пользователь обладает локальной привилегией, позволяющей изменять документы в конкретном периоде.

Добавлять статус документа могут пользователи, способные просматривать этот документ и
обладающие хотя бы одним из следующих свойств:
- `len(set(get_user_roles(user, document)) & set(add_status.roles)) > 0` - пользователь обладает ролью,
позволяющей добавлять статус.

Удалять статус документа могут пользователи, способные просматривать этот документ и
обладающие хотя бы одним из следующих свойств:
- `dcis.change_document` - пользователь обладает глобальной привилегией, позволяющей изменять любой видимый документ;
- `Document.period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается изменить документ, и обладает возможностью создания проектов;
- `Document.period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период, в котором пытается изменить документ, и обладает возможностью создания периодов;
- `change_document` - пользователь обладает локальной привилегией, позволяющей изменять документы в конкретном периоде.

## Привилегии и права для работы с таблицей периода и документа

### Режим редактирования таблицы периода

Режим редактирования таблицы периода доступен по ссылке
`/dcis/periods/_periodId/sheets`, где `_periodId` - идентификатор периода.

Переход в данный режим возможен, если пользователь может просматривать период
и выполняется хотя бы одно из следующих условий:
- пользователь обладает глобальной привилегией `dcis.change_sheet`,
  позволяющей изменять таблицу любого видимого периода;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в котором находится период, и обладает возможность создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период и обладает возможностью создания периодов;
- пользователь обладает локальной привилегией `change_sheet` для периода.

В данном режиме пользователь может:
- просматривать строки верхнего уровня, а также дочерние строки любых документов;
- изменять стили ячеек;
- изменять значения по умолчанию для ячеек;
- добавлять строки верхнего уровня;
- изменять свойства строк;
- удалять любые строки;
- добавлять колонки;
- изменять свойства колонок;
- удалять колонки.

> Изменения, внесенные в структуру таблицы периода, отражаются на всех собираемых документах периода.

### Режим заполнения/просмотра таблицы документа

Режим заполнения/просмотра таблицы документа доступен по ссылке
`/dcis/documents/_documentId`, где `_documentId` - идентификатор документа.

Переход в данный режим возможен, если пользователь может просматривать документ.

Заполнение документа, под которым понимаются любые изменения, доступно, если последний статус документа
позволяет редактирование `Document.last_status.editable == True`.

Значение ячейки может быть изменено, если одновременно:
- `Cell.editable == True` - ячейке может быть установлено значение;
- `Cell.formula is not None` - значение ячейки не устанавливается с помощью расчета формул.

Пользователь может изменять значение атрибута, если выполняется хотя бы одно из условий:
- пользователю доступен режим редактирования таблицы периода;
- пользователь создал документ;
- пользователь обладает глобальной привилегией `dcis.change_attributevalue`,
  позволяющей изменять значение любого атрибута видимого документа;
- пользователь обладает глобальной привилегией `dcis.change_value`,
  позволяющей изменять значение любой ячейки видимого документа;
- пользователь обладает локальной привилегией `change_value` для периода документа;
- в множественном типе сбора:
  - пользователь состоит в дивизионе, к которому привязан документ;
- в единичном типе сбора:
  - пользователь состоит в дивизионе, к которому привязана одна из строк документа.

Пользователь может изменять значение ячейки,
если значение ячейки может быть изменено и выполняется хотя бы одно из следующих условий:
- пользователю доступен режим редактирования таблицы периода;
- пользователь создал документ;
- пользователь обладает глобальной привилегией `dcis.change_value`,
  позволяющей изменять значение любой ячейки видимого документа;
- пользователь обладает локальной привилегией `change_value` для периода документа;
- в множественном типе сбора:
  - пользователь состоит в дивизионе, к которому привязан документ;
- в единичном типе сбора:
  - строка с ячейкой является строкой верхнего уровня;
  - пользователь состоит в дивизионе, которому принадлежит строка с ячейкой.

Пользователь может добавлять дочерние строки для строк, помеченных флагом `dynamic == True`,
если выполняется хотя бы одно из следующих условий:
- пользователю доступен режим редактирования таблицы периода;
- пользователь создал документ;
- пользователь обладает глобальной привилегией `dcis.add_rowdimension`;
- пользователь обладает локальной привилегией `add_rowdimension`;
- в множественном типе сбора:
  - пользователь состоит в дивизионе, к которому привязан документ;
- в единичном типе сбора:
  - строка является строкой верхнего уровня;
  - пользователь состоит в дивизионе, к которому привязана строка.

Пользователь может изменять высоту дочерней строки, если выполняется хотя бы одно из следующих условий:
- пользователю доступен режим редактирования таблицы периода;
- пользователь создал документ;
- пользователь обладает глобальной привилегией `dcis.change_rowdimension`;
- пользователь обладает локальной привилегией `change_rowdimension`;
- пользователь добавил дочернюю строку, для которой пытается изменить высоту.

Пользователь может удалять дочернюю строку, не имеющую собственных дочерних строк,
если выполняется хотя бы одно из следующих условий:
- пользователю доступен режим редактирования таблицы периода;
- пользователь создал документ;
- пользователь обладает глобальной привилегией `dcis.delete_rowdimension`;
- пользователь обладает локальной привилегией `delete_rowdimension`;
- пользователь добавил дочернюю строку, которую пытается удалить.

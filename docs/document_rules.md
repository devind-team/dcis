#  Правила вывода, формирования и прав доступа к собираемому документу

Настоящий файл содержит информацию о правилах фильтрации, о режимах работы документов.

## Механизм привилегий
Привилегии делятся на глобальные и локальные.
Глобальные привилегии устанавливаются для групп пользователей
по пути "Панели управления" -> "Администрирование" -> "Привилегии" и применяются для всего приложения.
Локальные привилегии устанавливаются для конкретных пользователей или групп пользователей
в настройках каждого периода (панель Пользователи) и действуют только на этот период.

## Привилегии и права для работы с Проектами сборов

Просматривать проекты могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.view_project` - глобальная привилегия, позволяющая просматривать все проекты;
- `Project.user_id == info.context.user.id` - пользователь создал проект;
- `info.context.user.divisions in Project.period_set.divisions` - пользователь добавлен в дивизион, который участвует в проекте сбора;
- `info.context.user in Projects.period.periodgroup.users` - пользователь добавлен в группу в сборе.

Добавлять проект могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.add_project` - глобальная привилегия, позволяющая добавлять проекты.

Изменять проект могут пользователи, обладающими следующими свойствами или привилегиями:
- `dcis.change_project` - глобальная привилегия, позволяющая изменить любой проект;
- `Project.user_id == info.context.user.id && dcis.add_project` - пользователь 
  создавший проект и обладающий возможностью создания проектов.

Удалять проект могут пользователи, обладающими следующими свойствами или привилегиями:
- `dcis.delete_project` - глобальная привилегия, позволяющая удалить любой проект;
- `Project.user_id == info.context.user.id && dcis.add_project && Project.period_set.count() == 0` - пользователь,
  создавший проект и обладающий возможность создания проектов, а также проект не должен иметь периодов.

## Привилегии и права для работы с Периодами проекта сборов

Просматривать периоды могут пользователи, обладающими следующими свойствами и привилегиями:
- `dcis.view_project` && `dcis.view_period` - пользователь обладает двумя привилегиями;
- `Period.user == info.context.user` - пользователь создал период;
- `info.context.user in Period.groups` - пользователь состоит в группе периода;
- `info.context.user.divisions in Perdiod.divisions` - пользователь состоит в дивизионе

Добавлять период могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.add_period` - глобальная привилегия, позволяющая добавлять период в любой проект;
- `Project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в который пытается добавить период, и обладающий возможностью создания проектов.

Изменять дивизионы периода могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.change_period` - глобальная привилегия, позволяющая изменить любой период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в периоде которого пытается изменить дивизионы, и обладающий возможностью создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь,
  создавший период, в котором пытается изменить дивизионы, и обладающий возможностью создания периодов;
- `change_period` - локальная привилегия, позволяющая изменять конкретный период;
- `change_divisions` - локальная привилегия, позволяющая изменять дивизионы конкретного периода.

Изменять пользователей периода могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.change_period` - глобальная привилегия, позволяющая изменить любой период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в периоде которого пытается изменить пользователей, и обладающий возможность создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь,
  создавший период, в котором пытается изменить пользователей, и обладающий возможностью создания периодов;
- `change_period` - локальная привилегия, позволяющая изменять конкретный период;
- `change_users` - локальная привилегия, позволяющая изменять пользователей конкретного периода.

Изменять настройки периода могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.change_period` - глобальная привилегия, позволяющая изменить любой период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в периоде которого пытается изменить настройки, и обладающий возможностью создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь,
  создавший период, в котором пытается изменить настройки, и обладающий возможностью создания периодов.

Удалять период могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.delete_period` - глобальная привилегия, позволяющая удалить любой период;
- `Period.project.user_id == info.context.user_id && dcis.add_project && Period.document_set.count() == 0` - 
  пользователь, создавший проект, в котором пытается удалить период, и обладающий возможностью создания проектов,
  при этом в периоде не должно быть созданных документов;
- `Period.project.user_id == info.context.user.id && dcis.add_period && Period.document_set.count() == 0` - 
  пользователь, создавший период, который пытается удалить, и обладающий возможностью создания периодов,
  при этом в периоде не должно быть созданных документов.

## Привилегии и права для работы с **Документами** периода сборов

Добавлять документ могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.add_document` - глобальная привилегия, позволяющая добавлять документ в любой период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в периоде которого пытается добавить документ, и обладающий возможность создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь,
  создавший период, в котором пытается добавить документ, и обладающий возможностью создания периодов;
- `add_document` - локальная привилегия, позволяющая добавлять документы в конкретный период.

Удалять документ могут пользователи, обладающие следующими свойствами или привилегиями:
- `dcis.delete_document` - глобальная привилегия, позволяющая удалять любой документ;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь,
  создавший проект, в периоде которого пытается удалить документ, и обладающий возможностью создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь,
  создавший период, в котором пытается удалить документ, и обладающий возможностью создания периодов.

## Режим создания периодов

При создании периода указывается тип сбора:
- **множественный** - для каждого дивизиона создается свой уникальный документ со своим сквозным версионированием. 
- **единичный** - для всех дивизионов создается единый документ, фильтрация осуществляется на уровне динамических строк.

## Права доступа и режимы работы с документами

Работа с документом может осуществляться в двух режимах:
- режим редактирования документа (доступен по ссылке `/dcis/periods/_periodId/sheets`);
- режим заполнения/просмотра документа (доступен по ссылке `/dcis/documents/_documentId`).

Для режимов редактирования/заполнения/просмотра на каждый период/документ формируется флаги действий:
- `change`, **изменения в котором влияют на все документы периода**, и пользователь может:
  - просматривать строки верхнего уровня, а также дочерние строки любых документов;
  - изменять стили ячеек;
  - изменять значения по умолчанию для ячеек;
  - добавлять строки верхнего уровня;
  - изменять свойства строк;
  - удалять любые строки;
  - добавлять колонки;
  - изменять свойства колонок;
  - удалять колонки.
- `write` - в котором пользователь может:
  - изменять значение ячейки в множественном режиме, если:
    - пользователь имеет глобальную привилегию `dcis.change_value`;
    - пользователь имеет локальную привилегию `change_value` для периода документа;
    - пользователь состоит в дивизионе, к которому привязан документ;
  - изменять значение ячейки в единичном режиме, если:
    - пользователь имеет глобальную привилегию `dcis.change_value`;
    - пользователь имеет локальную привилегию `change_value` для периода документа;
    - пользователь состоит в дивизионе, которому принадлежит строка с ячейкой;
  - добавлять подстроки для строк помеченных флагом `dynamic == True`, если:
    - пользователь имеет глобальную привилегию `dcis.add_rowdimension`;
    - пользователь имеет локальную привилегию `add_rowdimension`;
  - удалять подстроку, не имеющую собственных подстрок, если:
    - пользователь имеет глобальную привилегию `dcis.delete_rowdimension`;
    - пользователь имеет локальную привилегию `delete_rowdimension`;
    - пользователь добавил подстроку, которую хочет удалить.
- `read` - в котором пользователь может только просматривать документ.

Пользователь не обладающей привилегиями выше перенаправляется на страницу 404.

Вычисления режимов происходит для каждого пользователя во время запроса документа/периода,
если выполняется хотя бы одно условие:
- `change`
  - пользователь имеет глобальную привилегию `dcis.add_project` и создал проект,
    в котором находится документ `document.period.project.user_id == info.context.user.id`
  - пользователь имеет глобальную привилегию `dcis.add_period` и создал период,
    в котором находится документ `document.period.user_id == info.context.user.id`
  - пользователь имеет глобальную привилегию `dcis.change_sheet`
  - пользователь имеет локальную привилегию `change_sheet`
- `write`
  - пользователю доступен режим `change`
  - пользователь имеет глобальную привилегию `dcis.change_value`
  - пользователь имеет локальную привилегию `change_value` для периода документа
  - пользователь имеет глобальную привилегию `dcis.add_rowdimension`
  - пользователь имеет локальную привилегию `add_rowdimension` для периода документа
  - пользователь имеет глобальную привилегию `dcis.delete_rowdimension`
  - пользователь имеет локальную привилегию `delete_rowdimension` для периода документа
- `read`
  - пользователь имеет глобальную привилегию `dcis.view_document`
  - пользователь имеет локальную привилегию `view_document` для периода документа
  - пользователь состоит в дивизионе,
    к которому привязан документ `document.object_id in get_user_divisions(info.context.user, document.period.project)`

Выборка документов для пользователей осуществляется по следующему алгоритму:
- все документы, если:
  - пользователь обладает глобальной привилегией `dcis.view_document`
  - пользователь обладает локальной привилегией `view_dicument`
- ограниченные документы:
  - выводятся документы, дивизионы которого входят в состав дивизионом пользователя с привязкой к выбираемому периоду.

> При изменении собираемого документа периода, изменения отражаются на всех собираемых документах.

Редактирование документа доступно по адресу **/dcis/periods/_periodId/sheets**,
где `_periodId` - идентификатор периода.

Заполнение документа доступно по адресу **/dcis/documents/_documentId**,
где `_documentId` - идентификатор заполняемого документа.

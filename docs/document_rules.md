#  Правила вывода, формирования и прав доступа к собираемому документу

Настоящий файл содержит информацию о правилах фильтрации, о режимах работы документов.

## Выборка объектов

Пользователь видит в соответствующей таблице только те проекты, периоды и документы, которые он может просматривать.

## Режим создания периодов

При создании периода указывается тип сбора:
- **множественный** - для каждого дивизиона создается свой уникальный документ со своим сквозным версионированием. 
- **единичный** - для всех дивизионов создается единый документ, фильтрация осуществляется на уровне динамических строк.

## Механизм привилегий

Привилегии делятся на глобальные и локальные.
Глобальные привилегии устанавливаются для групп пользователей
по пути "Панели управления" -> "Администрирование" -> "Привилегии" и применяются для всего приложения.
Локальные привилегии устанавливаются для конкретных пользователей или групп пользователей
в настройках каждого периода (панель Пользователи) и действуют только на этот период.

## Привилегии и права для работы с Проектами сборов

Просматривать проект могут пользователи, обладающие хотя бы одним из следующих свойств:
- `dcis.view_project` - пользователь обладает глобальной привилегией, позволяющей просматривать все проекты;
- `Project.user_id == info.context.user.id` - пользователь создал проект;
- `info.context.user in Project.period.user` - пользователь создал один из периодов проекта;
- `info.context.user in Project.period.periodgroup.users` - пользователь состоит в группе одного из периодов проекта;
- `Project in get_user_privilages_projects(user)` - пользователь имеет привилегию для одного из периодов проекта;
- `Project in get_user_divisions_projects(user)` - пользователь состоит в дивизионе, который участвует в проекте.

Добавлять проект могут пользователи, обладающие хотя бы одним из следующих свойств:
- `dcis.add_project` - пользователь обладает глобальной привилегией, позволяющей добавлять проекты.

Изменять проект могут пользователи, способные просматривать этот проект и обладающие хотя бы одним из следующих свойств:
- `dcis.change_project` - пользователь обладает глобальной привилегией, позволяющей изменить любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project` - пользователь 
  создал проект и обладает возможностью создания проектов.

Удалять проект могут пользователи, способные просматривать этот проект и обладающие хотя бы одним из следующих свойств:
- `dcis.delete_project` - пользователь обладает глобальной привилегией, позволяющей удалить любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project && Project.period_set.count() == 0` - пользователь
  создал проект и обладает возможностью создания проектов, а также проект не должен иметь периодов.

## Привилегии и права для работы с Периодами проекта сборов

Просматривать период могут пользователи, способные просматривать проект периода и
обладающие хотя бы одним из следующих свойств:
- `dcis.view_period` - пользователь обладает глобальной привилегией,
  позволяющей просматривать все периоды в рамках проекта;
- `Period.project.user.id == info.context.user.id` - пользователь создал проект с периодом;
- `Period.user.id == info.context.user.id` - пользователь создал период;
- `info.context.user in Period.groups` - пользователь состоит в группе периода;
- `Period in get_user_privileges_periods(user)` - пользователь имеет привилегию для периода;
- `Period in get_user_divisions_periods(user)` - пользователь состоит в дивизионе, который участвует в периоде.

Добавлять период могут пользователи, способные просматривать проект периода и
обладающие хотя бы одним из следующих свойств:
- `dcis.add_period` - пользователь обладает глобальной привилегией, позволяющей добавлять период в любой видимый проект;
- `Project.user_id == info.context.user.id && dcis.add_project` - пользователь
  создал проект, в который пытается добавить период, и обладает возможностью создания проектов.

Изменять период могут пользователи, способные просматривать этот период и обладающие хотя бы одним из следующих свойств:
- `dcis.change_period` - пользователь обладает глобальной привилегией, позволяющей изменить любой видимый период;
- `Period.project.user_id == info.context.user.id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается изменить дивизионы, и обладает возможностью создания проектов;
- `Period.user_id == info.context.user.id && dcis.add_period` - пользователь
  создал период, в котором пытается изменить дивизионы, и обладает возможностью создания периодов;
- `change_period` - пользователь обладает локальной привилегией, позволяющей изменять конкретный период.

Изменять дивизионы периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_divisions` - пользователь обладает локальной привилегией,
  позволяющей изменять дивизионы конкретного периода.

Изменять пользователей периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_users` - пользователь обладает локальной привилегией,
  позволяющая изменять пользователей конкретного периода.

Изменять настройки периода могут пользователи, обладающие хотя бы одним из следующих свойств:
- пользователь может изменять период;
- `change_period_settings` - пользователь обладает локальной привилегией,
  позволяющая изменять настройки конкретного периода.

Удалять период могут пользователи, способные просматривать этот период и обладающие хотя бы одним из следующих свойств:
- `dcis.delete_period` - пользователь обладает глобальной привилегией, позволяющей удалить любой видимый период;
- `Period.project.user_id == info.context.user.id && dcis.add_project && Period.document_set.count() == 0` - 
  пользователь создал проект, в котором пытается удалить период, и обладает возможностью создания проектов,
  при этом в периоде не должно быть созданных документов;
- `Period.user_id == info.context.user.id && dcis.add_period && Period.document_set.count() == 0` - 
  пользователь создал период, который пытается удалить, и обладает возможностью создания периодов,
  при этом в периоде не должно быть созданных документов.

## Привилегии и права для работы с **Документами** периода сборов

Просматривать документ могут пользователи, способные просматривать период документа и
обладающие хотя бы одним из следующих свойств:
- `dcis.view_document` - пользователь обладает глобальной привилегией,
  позволяющей просматривать все документы в рамках периода;
- `Document.period.project.user_id == info.context.user.id` - пользователь создал проект документа;
- `Document.period.user_id == info.context.user.id` - пользователь создал период документа;
- `Document.object_id in get_user_divisions(info.context.user, Document.period.project)` - период создан с
  множественным типом сбора, и пользователь добавлен в закрепленный за документом дивизион;
- `Document.rowdimension__object_id in get_user_divisions(info.context.user, Document.period.project)` - период создан с
  единичным типом сбора, и пользователь добавлен в закрепленный за одной из строк документа дивизион;
- `view_document` - пользователь обладает локальной привилегией,
  позволяющей просматривать все документы конкретного периода;

Добавлять документ могут пользователи, способные просматривать период документа и
обладающие хотя бы одним из следующих свойств:
- `dcis.add_document` - пользователь обладает глобальной привилегией, позволяющей добавлять документ
  в любой видимый период;
- `Period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается добавить документ, и обладает возможность создания проектов;
- `Period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период, в котором пытается добавить документ, и обладает возможностью создания периодов;
- `add_document` - пользователь обладает локальной привилегией, позволяющей добавлять документы в конкретный период.

Удалять документ могут пользователи, способные просматривать этот документ и
обладающие хотя бы одним из следующих свойств:
- `dcis.delete_document` - пользователь обладает глобальной привилегией, позволяющей удалять любой видимый документ;
- `Document.period.project.user_id == info.context.user_id && dcis.add_project` - пользователь
  создал проект, в периоде которого пытается удалить документ, и обладает возможностью создания проектов;
- `Document.period.user_id == info.context.user_id && dcis.add_period` - пользователь
  создал период, в котором пытается удалить документ, и обладает возможностью создания периодов;
- `delete_document` - пользователь обладает локальной привилегией, позволяющей удалять документы из конкретного периода.

## Права доступа и режимы работы с документами

Работа с документом может осуществляться в двух режимах:
- режим редактирования документа (доступен по ссылке `/dcis/periods/_periodId/sheets`);
- режим заполнения/просмотра документа (доступен по ссылке `/dcis/documents/_documentId`).

Для режимов редактирования/заполнения/просмотра на каждый период/документ формируется флаги действий:
- `change`, **изменения в котором влияют на все документы периода**, и пользователь может:
  - просматривать строки верхнего уровня, а также дочерние строки любых документов;
  - изменять стили ячеек;
  - изменять значения по умолчанию для ячеек;
  - добавлять строки верхнего уровня;
  - изменять свойства строк;
  - удалять любые строки;
  - добавлять колонки;
  - изменять свойства колонок;
  - удалять колонки.
- `write` - в котором пользователь может:
  - изменять значение ячейки в множественном режиме, если:
    - пользователь имеет глобальную привилегию `dcis.change_value`;
    - пользователь имеет локальную привилегию `change_value` для периода документа;
    - пользователь состоит в дивизионе, к которому привязан документ;
  - изменять значение ячейки в единичном режиме, если:
    - пользователь имеет глобальную привилегию `dcis.change_value`;
    - пользователь имеет локальную привилегию `change_value` для периода документа;
    - пользователь состоит в дивизионе, которому принадлежит строка с ячейкой;
  - добавлять подстроки для строк помеченных флагом `dynamic == True`, если:
    - пользователь имеет глобальную привилегию `dcis.add_rowdimension`;
    - пользователь имеет локальную привилегию `add_rowdimension`;
  - удалять подстроку, не имеющую собственных подстрок, если:
    - пользователь имеет глобальную привилегию `dcis.delete_rowdimension`;
    - пользователь имеет локальную привилегию `delete_rowdimension`;
    - пользователь добавил подстроку, которую пытается удалить.
- `read` - в котором пользователь может только просматривать документ.

Пользователь не обладающей привилегиями выше перенаправляется на страницу 404.

Вычисления режимов происходит для каждого пользователя во время запроса видимого документа,
если выполняется хотя бы одно условие:
- `change`
  - пользователь имеет глобальную привилегию `dcis.add_project` и создал проект,
    в котором находится документ `document.period.project.user_id == info.context.user.id`
  - пользователь имеет глобальную привилегию `dcis.add_period` и создал период,
    в котором находится документ `document.period.user_id == info.context.user.id`
  - пользователь имеет глобальную привилегию `dcis.change_sheet`
  - пользователь имеет локальную привилегию `change_sheet`
- `write`
  - пользователю доступен режим `change`
  - пользователь имеет глобальную привилегию `dcis.change_value`
  - пользователь имеет локальную привилегию `change_value` для периода документа
  - пользователь имеет глобальную привилегию `dcis.add_rowdimension`
  - пользователь имеет локальную привилегию `add_rowdimension` для периода документа
  - пользователь имеет глобальную привилегию `dcis.delete_rowdimension`
  - пользователь имеет локальную привилегию `delete_rowdimension` для периода документа
- `read` в остальных случаях

> Изменения, внесенные в структуру документа в режиме `change`, отражаются на всех собираемых документах периода.

Редактирование документа доступно по адресу **/dcis/periods/_periodId/sheets**,
где `_periodId` - идентификатор периода.

Заполнение документа доступно по адресу **/dcis/documents/_documentId**,
где `_documentId` - идентификатор заполняемого документа.

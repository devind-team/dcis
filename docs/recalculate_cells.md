# Пересчет ячеек


## 1. Достаем все формульные зависимости для всех документов используя [django адаптер](https://docs.djangoproject.com/en/4.0/topics/cache/)

Модуль хранения зависимостей для расчета формул при изменении значений.

При изменении значения ячейки необходимо пересчитывать значение ячейки и всех связных.
Каждый раз вытаскивать все ячейки не целесообразно, можно вытаскивать только связные.


|  #  | Параметр   | Показатель А | Показатель Б | Сумма       |
|:---:|:-----------|-------------:|-------------:|:------------|
|  #  | Параметр 1 |           30 |            5 | =С2 + D2    |
|  #  | Параметр 2 |           40 |            7 | =С3 + D3    |
|  #  | Параметр 3 |           50 |            9 | =С4 + D4    |
|     |            |              |       Итого: | =SUM(E2:E4) |
При изменении ячейки C2 30 -> 40 идет пересчет ячеек:
- E2
- E5

По итогу мы изменяем значения С2, E2, E5.
Формулы работают только на 1 уровне, где parent_id == None.

Для этого используется структура для хранения кеша:
```python
from dataclasses import dataclass, field
from collections import defaultdict

KEY_TEMPLATE = 'cache.sheet.%s'

@dataclass
class FormulaDependencyCache:
    """Структура для хранения кеша.

        - sheet_name - название листа
        - sheet_id - идентификатор листа в БД
        - dependency - частотная зависимость. Какие значения нужно получить, чтобы посчитать значение.
        - inversion - инверсивная зависимость. Какие ячейки нужно посчитать, если изменяется выбранная
    """
    sheet_name: str

    sheet_id: int | None = None

    dependency: dict[str, dict[str, int]] = field(default_factory=lambda: defaultdict(dict))
    inversion: dict[str, list[str]] = field(default_factory=lambda: defaultdict(list))

    @property
    def key(self) -> str:
        return KEY_TEMPLATE % self.sheet_id
```

Структура держит 4 поля:
- **sheet_name** - название листа
- **sheet_id** - идентификатор листа в БД
- **dependency** - частотная зависимость. Какие значения нужно получить, чтобы посчитать значение.
- **inversion** - инверсивная зависимость. Какие ячейки нужно посчитать, если изменяется выбранная

## 2. Вытаскиваем цепочки зависимостей всех связных ячеек


# Модуль sheet_cache_service

Модуль хранения зависимостей для расчета формул при изменении значений. При изменении значения ячейки необходимо пересчитывать значение ячейки и всех связных. Каждый раз вытаскивать все ячейки не целесообразно, можно вытаскивать только связные. +-----+--------------+--------------+--------------+-------------+ | # | Параметр | Показатель А | Показатель Б | Сумма | +-----+--------------+--------------+--------------+-------------+ | # | Параметр 1 | 30 | 5 | =С2 + D2 | +-----+--------------+--------------+--------------+-------------+ | # | Параметр 2 | 40 | 7 | =С3 + D3 | +-----+--------------+--------------+--------------+-------------+ | # | Параметр 3 | 50 | 9 | =С4 + D4 | +-----+--------------+--------------+--------------+-------------+ | Итого: | =SUM(E2:E4) | +-----+--------------+--------------+--------------+-------------+ При изменении ячейки C2 30 -> 40 идет пересчет ячеек: - E2 - E5 По итогу мы изменяем значения С2, E2, E5. Формулы работают только на 1 уровне, где parent_id == None. Используем django адаптер: https://docs.djangoproject.com/en/4.0/topics/cache/

### Функции

| Сигнатура                                                                                                       | Декораторы | Описание                                |
| :-------------------------------------------------------------------------------------------------------------- | :--------- | :-------------------------------------- |
| save_to_cache( formula_dependency: apps.dcis.services.sheet_cache_service.FormulaDependencyCache) -&#62; bool   | -          | Сохраняем структуру зависимостей в кеш. |
| get_from_cache( sheet_id: int) -&#62; apps.dcis.services.sheet_cache_service.FormulaDependencyCache &#124; None | -          | Забираем структуру из кеша.             |
| delete_from_cache(sheet_id: int) -&#62; bool                                                                    | -          | Удаление структуры из кеша.             |
| dependency_formula(formula: str) -&#62; list[str]                                                               | -          | Возвращает зависимость токенов.         |

## Класс FormulaDependencyCache

Структура для хранения кеша. - sheet_name - название листа - sheet_id - идентификатор листа в БД - dependency - частотная зависимость. Какие значения нужно получить, чтобы посчитать значение. - inversion - инверсивная зависимость. Какие ячейки нужно посчитать, если изменяется выбранная

### Методы

| Сигнатура                                                                                                                                                                          | Декораторы | Описание            |
| :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------- | :------------------ |
| __init__( self, sheet_name: str, sheet_id: int &#124; None = None, dependency: dict[str, dict[str, int]] = &#60;factory&#62;, inversion: dict[str, list[str]] = &#60;factory&#62;) | -          | -                   |
| __repr__(self)                                                                                                                                                                     | -          | Return repr(self).  |
| __eq__(self, other)                                                                                                                                                                | -          | Return self==value. |

## Класс FormulaContainerCache

Контейнер для упрощения работы с кешом.

### Методы

| Сигнатура                                                                        | Декораторы  | Описание                                                                                                                                                                                              |
| :------------------------------------------------------------------------------- | :---------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| __init__(self, name: str, sheet_id: int &#124; None = None)                      | -           | -                                                                                                                                                                                                     |
| recalculate_dependency(self, coordinate: str) -&#62; tuple[list[str], list[str]] | -           | Рассчитываем значения связанных ячеек.Нужно вычислить какие ячейки необходимо пересчитать и какие ячейкии какие данные нужны. - relation - выбираемые ячейки - recalculation - пересчитываемые ячейки |
| add_formula(self, coordinate: str, formula: str)                                 | -           | Добавление информации в зависимость:param coordinate: координата ячейки:param formula: формула:return:                                                                                                |
| change_formula(self, coordinate: str, formula: str)                              | -           | Изменяем формулу в ячейки.                                                                                                                                                                            |
| delete_formula(self, coordinate: str)                                            | -           | Удаление информации о формуле в зависимости.                                                                                                                                                          |
| rename_sheet(self, old_value: str, new_value: str)                               | -           | Функционал для изменения названия листов.                                                                                                                                                             |
| save(self, sheet_id: int &#124; None = None) -&#62; bool                         | -           | -                                                                                                                                                                                                     |
| get(cls, sheet: apps.dcis.models.document.Sheet)                                 | classmethod | Вытягиваем контейнер из кеша или строим новый.                                                                                                                                                        |
| delete(self) -&#62; bool                                                         | -           | -                                                                                                                                                                                                     |
| from_cache(cls, sheet_id: int)                                                   | classmethod | -                                                                                                                                                                                                     |
| build_cache(cls, sheet: apps.dcis.models.document.Sheet)                         | classmethod | -                                                                                                                                                                                                     |